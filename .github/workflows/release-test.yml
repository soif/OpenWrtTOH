name: Test Release Creation

on:
  push:
    branches:
      - release-test

permissions:
  contents: write  # Included for consistency, though not strictly needed for logging

jobs:
  test-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history

      - name: Fetch all branches
        run: |
          git fetch origin +refs/heads/*:refs/remotes/origin/*

      - name: Get Changelog Entry
        id: changelog
        run: |
          changelog=$(sed -n '/^## Version /{n; :a;p;n;/^$/q;ba}' CHANGELOG.md | sed '/^$/d')
          changelog=$'\n'"${changelog}"$'\n'
          changelog="${changelog//'%'/'%25'}"
          changelog="${changelog//$'\n'/'%0A'}"
          changelog="${changelog//$'\r'/'%0D'}"
          echo "content=$changelog" >> $GITHUB_OUTPUT

      - name: Get Contributors and Commits
        id: contributors
        run: |
          REPO_URL="https://github.com/${{ github.repository }}"
          # Get contributors sorted by commit count and deduplicated by author name
          contributors=$(git log --format='%an%x09%ae' | sort | uniq -c | sort -nr | awk -F'\t' '{
            count=$1; sub(/^[ \t]+[0-9]+[ \t]+/, ""); name=$1; email=$2;
            if (email ~ /\+.*@users\.noreply\.github\.com/) {
              username=tolower(substr(email, index(email, "+")+1, index(email, "@")-index(email, "+")-1));
            } else {
              username=tolower(substr(email, 1, index(email, "@")-1));
            }
            print "* " (name ~ / / ? name " ([@" username "](https://github.com/" username "))" : "[@" name "](https://github.com/" name ")")
          }' | sort -u)
          # Get all commits and escape % in messages
          git log --format='* [%h]('$REPO_URL'/commit/%H) %s ([%an](https://github.com/%an))' | sed 's/%/%25/g' > commits.txt
          commits=$(cat commits.txt)
          # Use GitHub Actions multi-line output syntax with a delimiter
          delimiter=$(openssl rand -hex 8)
          {
            echo "list<<$delimiter"
            echo "$contributors"
            echo "$delimiter"
          } >> $GITHUB_OUTPUT
          {
            echo "commits<<$delimiter"
            echo "$commits"
            echo "$delimiter"
          } >> $GITHUB_OUTPUT

      - name: Display Release Content
        run: |
          echo "### Changes"
          echo "${{ steps.changelog.outputs.content }}" | sed 's/%0A/\n/g'
          echo "_For more details, see the full [changelog](${{ github.server_url }}/${{ github.repository }}/blob/master/CHANGELOG.md) in the repository_"
          echo ""
          echo "### Contributors"
          echo "${{ steps.contributors.outputs.list }}"
          echo ""
          echo "### Commits"
          cat commits.txt
